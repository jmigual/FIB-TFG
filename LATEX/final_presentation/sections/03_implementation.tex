% !TEX root = ../main.tex

\section{Design and implementation}

\subsection{Pre-process data}
\begin{frame}{\insertsubsec}
  \begin{itemize}
    \item Pre-process image data
    \item Pre-process scalar data
    \item Generate pairs for training
  \end{itemize}

  \vspace{.5cm}
  Only 490 of the initial 671 could be used to fit a model because we needed the following 
  requirements:
  \begin{itemize}
    \item CT scan
    \item Tumour annotations
    \item Radiomic features
    \item Clinical information
  \end{itemize}
\end{frame}

\begin{frame}{Image data pre-processing}
  \begin{figure}
    \centering
    \scalebox{.6}{\input{drawings/preprocess.tikz.tex}}
    \caption{Image data pre-processing}
  \end{figure}
\end{frame}

\begin{frame}{Scalar data pre-processing}
  \begin{itemize}
    \item Clinical information
    \begin{itemize}
      \item Patient's ID
      \item Age
      \item Sex
      \item Survival event
      \item Survival time
    \end{itemize}
    \item Radiomic features, up to 725
    \begin{itemize}
      \item Tumour shape
      \item Intensity
      \item Volume
      \item ...
    \end{itemize}
  \end{itemize}
\end{frame}
\begin{frame}
  \begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/features_original}
    \caption{Features before normalization}
  \end{figure}
\end{frame}
\begin{frame}
  \begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/features_normalized}
    \caption{Features after normalization}
  \end{figure}
\end{frame}

\begin{frame}{Pair generation}
  
  \begin{figure}
    \centering
    \scalebox{.7}{\input{drawings/pairs_sets.tikz.tex}}
    \caption{Types of pairs generated from train and test sets}
  \end{figure}

  \begin{block}{Conditions}
    \begin{itemize}
      \item Both of them are uncensored \( E_A = E_B = 1 \)
      \item The uncensored time of one is smaller than the censored time of the other
            \( T_A < T_B | E_A = 1; E_B = 0 \)
    \end{itemize}
  \end{block}
\end{frame}

\subsection{Create basic siamese model}
\begin{frame}{\insertsubsec}
  Step required from a software engineering perspective. Future models should implement the 
  \( \operatorname{sister}(x) \) function.
  \begin{figure}
    \scalebox{.7}{\input{drawings/siamese_network.tikz.tex}}
    \caption{Siamese network illustration}
  \end{figure}
\end{frame}
\begin{frame}
  \begin{align*}
    \bm{O}_A &= \operatorname{sister}(\bm{X}_A) \\
    \bm{O}_B &= \operatorname{sister}(\bm{X}_B) \\
    \sigma(x) &= \frac{1}{1 + \exp(-x)} \\
    \hat{y} &= \sigma(||\bm{O}_B||_2 - ||\bm{O}_A||_2) 
  \end{align*}

  \[
    \mathcal{L}(\bm{y}, \hat{\bm{y}}) = -\frac{1}{N} \sum_{i = 1}^{N}
    (1 - y_i)\log(1 - \hat{y}_i) + y_i\log(\hat{y}_i)
  \]

  \[
    C(\bm{y}, \hat{\bm{y}}) = \mathcal{L}(\bm{y}, \hat{\bm{y}}) + 
    ||\bm{w}||_2
  \]
\end{frame}

\subsection{Build volume only model}
\begin{frame}{\insertsubsec}
  Very simple model to have a baseline

  \[
    \operatorname{sister}(\bm{X}) = w\cdot X_{\text{scalar}_{26}} + b
  \]
\end{frame}
\begin{frame}
  Parameters:
  \begin{itemize}
    \item Learning rate: 0,05
    \item Number of epochs: 200
    \item Batch size: The whole dataset
  \end{itemize}

  Previous state-of-the-art CI was 0,628.

  \begin{table}
    \centering
    \begin{tabular}{|c||c|c|c||c|c|c|}
      \cline{2-7}
      \multicolumn{1}{c|}{} & \multicolumn{3}{|c||}{\textbf{Pairs}} & 
      \multicolumn{3}{c|}{\textbf{Concordance Index}} \\
      \hline
      \textbf{Fold} & \textbf{Mixed} & \textbf{Train} & \textbf{Test} 
      & \textbf{Mixed} & \textbf{Train} & \textbf{Test} \\
      \hhline{=======}
      0 & 16.359 & 46.804 & 5.330 & 0,627 & 0,634 & 0,639 \\
      1 & 16.359 & 46.957 & 5.278 & 0,629 & 0,635 & 0,63 \\
      2 & 16.348 & 47.577 & 5.084 & 0,636 & 0,627 & 0,661 \\
      3 & 16.348 & 47.274 & 5.176 & 0,618 & 0,644 & 0,6 \\
      \hhline{=======}
      \textbf{Total} & 65.414 & 188.612 & 20.868 & 0,627 & 0,635 & 0,632 \\
      \hline
    \end{tabular}
  
    \caption[Volume Only 4-CV results]{
      Results for volume only model using 4-CV \label{tab:results-volume-4CV}
    }
  \end{table}
\end{frame}

\begin{frame}
  LOOCV CI is 0,627.
  \begin{figure}
    \centering
    \includegraphics[width=.8\textwidth]{images/results/c-index_volume}
    \caption[LOOCV volume only model results]{
      Volume only model results using LOOCV \label{fig:results-volume-LOOCV}
    }
  \end{figure}
\end{frame}

\subsection{Build shallow siamese network}
\begin{frame}{\insertsubsec}
  \begin{figure}
    \centering
    \scalebox{.7}{\input{drawings/siamese_0.tikz.tex}}
    \caption{Shallow siamese sister's network illustration \label{fig:shallow-implement}}
  \end{figure}
\end{frame}

\begin{frame}
  \begin{itemize}
    \item Learning rate: 0,05
    \item Number of epochs: 200
    \item Batch size: The whole dataset
  \end{itemize}

  \begin{table}
    \centering
    \begin{tabular}{|c||c|c|c||c|c|c|}
      \cline{2-7}
      \multicolumn{1}{c|}{} & \multicolumn{3}{|c||}{\textbf{Pairs}} & 
      \multicolumn{3}{c|}{\textbf{Concordance Index}} \\
      \hline
      \textbf{Fold} & \textbf{Mixed} & \textbf{Train} & \textbf{Test} 
      & \textbf{Mixed} & \textbf{Train} & \textbf{Test} \\
      \hhline{=======}
      0 & 16.359 & 46.804 & 5.330 & 0,627 & 0,634 & 0,639 \\
      1 & 16.359 & 46.957 & 5.278 & 0,629 & 0,635 & 0,63 \\
      2 & 16.348 & 47.577 & 5.084 & 0,636 & 0,627 & 0,661 \\
      3 & 16.348 & 47.274 & 5.176 & 0,618 & 0,644 & 0,6 \\
      \hhline{=======}
      \textbf{Total} & 65.414 & 188.612 & 20.868 & 0,627 & 0,635 & 0,632 \\
      \hline
    \end{tabular}
  
    \caption[Volume Only 4-CV results]{
      Results for volume only model using 4-CV \label{tab:results-volume-4CV}
    }
  \end{table}
\end{frame}

\subsection{Build scalar only siamese network}
\begin{frame}
  \begin{figure}
    \centering
    \input{drawings/scalar_0.tikz.tex}
    \caption{Scalar siamese network illustration \label{fig:scalar-implement}}
  \end{figure}
\end{frame}